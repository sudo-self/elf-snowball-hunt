<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elf Snowball Hunt - Enhanced Edition!</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        html, body {
            height: 100%;
            overflow-x: hidden;
            background: linear-gradient(135deg, #0a1e3d 0%, #1a4d7a 50%, #0f2b4d 100%);
        }

        body {
            font-family: 'Comic Sans MS', 'Arial Rounded MT Bold', 'Arial', sans-serif;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        /* HEADER */
        header {
            text-align: center;
            padding: 10px 0;
            width: 100%;
        }

        h1 {
            font-size: clamp(2rem, 5vw, 3.5rem);
            text-shadow: 3px 3px 0 #0a1e3d, 0 0 25px #4facfe, 0 0 40px #00b3ff;
            margin-bottom: 5px;
            animation: titleGlow 2s ease-in-out infinite, float 3s ease-in-out infinite;
            background: linear-gradient(to right, #ff6b6b, #4facfe, #4facfe, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            padding: 0 10px;
        }

        @keyframes titleGlow {
            0%, 100% { text-shadow: 3px 3px 0 #0a1e3d, 0 0 25px #4facfe, 0 0 40px #00b3ff; }
            50% { text-shadow: 3px 3px 0 #0a1e3d, 0 0 35px #4facfe, 0 0 60px #00b3ff; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }

        .subtitle {
            font-size: 1.1rem;
            text-shadow: 1px 1px 3px #0a1e3d;
            color: #cce7ff;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.4;
        }

        /* GAME AREA - FIXED CONTAINER */
        .game-area {
            position: relative;
            width: 100%;
            max-width: 900px;
            height: 500px;
            border-radius: 20px;
            overflow: hidden;
            background: linear-gradient(to bottom, #87ceeb, #e0f6ff, #ffffff);
            border: 4px solid rgba(255,255,255,.6);
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
        }

        #game-canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* START SCREEN - FIXED POSITION */
        .start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(10,30,61,0.95), rgba(26,77,122,0.95));
            z-index: 100;
        }

        .game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(10,30,61,0.97), rgba(26,77,122,0.97));
            z-index: 100;
        }

        .overlay-content {
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            border: 2px solid rgba(255,255,255,0.2);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        /* CROSSHAIR - FIXED */
        .crosshair {
            position: fixed;
            width: 32px;
            height: 32px;
            border: 3px solid red;
            border-radius: 50%;
            pointer-events: none;
            display: none;
            z-index: 1000;
            box-shadow: 0 0 10px rgba(255,0,0,0.8);
            animation: pulse 1.5s infinite;
            transform: translate(-50%, -50%);
        }

        /* Add these missing styles */
        .game-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            width: 100%;
            max-width: 900px;
            padding: 12px 20px;
            background: linear-gradient(135deg, rgba(74,144,226,.25), rgba(80,227,194,.25));
            border-radius: 16px;
            border: 3px solid rgba(255,255,255,.2);
            backdrop-filter: blur(12px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .powerup-bar {
            width: 100%;
            max-width: 900px;
            height: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .controls {
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .combo-display {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #ff6b6b, #ffd166);
            color: white;
            padding: 12px 25px;
            border-radius: 30px;
            font-size: 1.5rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
            display: none;
            z-index: 50;
        }

        .powerup-indicator {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #ff0000, #ffffff);
            color: #ff0000;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1.2rem;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: none;
            z-index: 50;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .game-area {
                height: 400px;
                max-width: 95%;
            }
            
            .game-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .game-area {
                height: 350px;
            }
            
            .overlay-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-candy-cane"></i> Elf Snowball Hunt! <i class="fas fa-candy-cane"></i></h1>
            <p class="subtitle">üéØ Click to throw snowballs at mischievous elves hiding in the winter park! Chain hits for massive combos!</p>
        </header>

        <div class="game-stats">
            <div class="stat-box">
                <div class="stat-label">‚≠ê Score</div>
                <div class="stat-value" id="score">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">‚è±Ô∏è Time</div>
                <div class="stat-value" id="timer">60</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">üéØ Elves Hit</div>
                <div class="stat-value" id="hits">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">üî• Combo</div>
                <div class="stat-value" id="combo">0</div>
            </div>
        </div>

        <div class="powerup-bar">
            <div class="powerup-fill" id="powerup-bar"></div>
        </div>

        <div class="game-area">
            <canvas id="game-canvas"></canvas>
            <div class="combo-display" id="combo-display">COMBO x2!</div>
            <div class="powerup-indicator" id="powerup-indicator">üç¨ CANDY CANE POWER! üç¨</div>
            
            <div class="start-screen" id="start-screen">
                <div class="overlay-content">
                    <h2>üéÑ Elf Snowball Hunt! üéÑ</h2>
                    <p style="font-size: 1.4rem; margin: 20px 0; color: #4facfe;">Can you survive the mischievous elves?</p>
                    
                    <div class="difficulty-selector">
                        <div class="difficulty-btn active" data-difficulty="easy">Easy</div>
                        <div class="difficulty-btn" data-difficulty="normal">Normal</div>
                        <div class="difficulty-btn" data-difficulty="hard">Hard</div>
                    </div>
                    
                    <div class="instructions-list">
                        <ul>
                            <li>üéØ <strong>Click to throw snowballs</strong> at peeking elves</li>
                            <li>‚ö° <strong>Hit elves quickly!</strong> After 3 seconds, they fight back!</li>
                            <li>üî• <strong>Build combos</strong> for bonus points (up to x10!)</li>
                            <li>üéÅ <strong>Collect presents</strong> for special powerups</li>
                            <li>üç¨ <strong>Candy Cane Power</strong> = Triple shot for 10 seconds!</li>
                            <li>üåô <strong>Night Mode</strong> activates at 30 seconds - elves get faster!</li>
                        </ul>
                    </div>
                    
                    <button id="start-btn" style="margin-top: 20px;">
                        <i class="fas fa-play"></i> Start Game!
                    </button>
                </div>
            </div>
            
            <div class="game-over" id="game-over">
                <div class="overlay-content">
                    <h2>üéÑ Game Over! üéÑ</h2>
                    <div style="margin: 25px 0; font-size: 1.2rem;">
                        <p>Final Score: <span id="final-score" style="color: #ffd700; font-size: 1.8rem;">0</span></p>
                        <p>Elves Hit: <span id="final-hits" style="color: #4facfe;">0</span></p>
                        <p>Best Combo: <span id="final-combo" style="color: #ff6b6b;">0</span></p>
                        <p>Accuracy: <span id="final-accuracy" style="color: #42e695;">0%</span></p>
                        <p style="font-size: 1.1rem; margin-top: 15px;">Time Survived: <span id="final-time">60s</span></p>
                    </div>
                    <p id="rank-display" style="font-size: 1.5rem; color: #ffd700; margin: 15px 0;"></p>
                    <button id="play-again-btn">
                        <i class="fas fa-redo"></i> Play Again
                    </button>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="instructions">
                <p><i class="fas fa-mouse-pointer"></i> Click anywhere to throw snowballs at the elves! Chain hits for combo bonuses! <i class="fas fa-fire" style="color: #ff6b6b;"></i></p>
            </div>
            
            <div class="action-buttons">
                <button id="pause-btn"><i class="fas fa-pause"></i> Pause</button>
                <button id="sound-btn"><i class="fas fa-volume-up"></i> Sound: ON</button>
                <button id="reset-btn"><i class="fas fa-redo"></i> Reset Game</button>
            </div>
        </div>
    </div>

    <div class="crosshair" id="crosshair"></div>

    <script>
        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            
            // Game settings
            const DIFFICULTY = {
                easy: { elfSpeed: 1.0, spawnRate: 0.01, elfHealth: 1, time: 90 },
                normal: { elfSpeed: 1.2, spawnRate: 0.015, elfHealth: 1, time: 60 },
                hard: { elfSpeed: 1.5, spawnRate: 0.02, elfHealth: 2, time: 45 }
            };

            // Game variables
            let score = 0;
            let timeLeft = 60;
            let hits = 0;
            let misses = 0;
            let combo = 0;
            let maxCombo = 0;
            let comboTimer = 0;
            let throws = 0;
            let gameActive = false;
            let gameStarted = false;
            let gamePaused = false;
            let soundEnabled = true;
            let currentDifficulty = 'normal';
            let isNightTime = false;
            
            // Game objects
            let elves = [];
            let trees = [];
            let snowballsInAir = [];
            let particles = [];
            let snowflakes = [];
            let powerups = [];
            let candyCaneActive = false;
            let candyCaneTimer = 0;
            let candyCaneDuration = 10000;
            let lastTime = 0;
            let groundY = 0;
            
            // DOM elements
            const scoreElement = document.getElementById('score');
            const timerElement = document.getElementById('timer');
            const hitsElement = document.getElementById('hits');
            const comboElement = document.getElementById('combo');
            const comboDisplay = document.getElementById('combo-display');
            const gameOverElement = document.getElementById('game-over');
            const finalScoreElement = document.getElementById('final-score');
            const finalHitsElement = document.getElementById('final-hits');
            const finalComboElement = document.getElementById('final-combo');
            const finalAccuracyElement = document.getElementById('final-accuracy');
            const finalTimeElement = document.getElementById('final-time');
            const rankDisplay = document.getElementById('rank-display');
            const powerupIndicator = document.getElementById('powerup-indicator');
            const powerupBar = document.getElementById('powerup-bar');
            const startScreen = document.getElementById('start-screen');
            const canvas = document.getElementById('game-canvas');
            const ctx = canvas.getContext('2d');
            const crosshair = document.getElementById('crosshair');

            // Initialize game
            function initGame() {
                resizeCanvas();
                
                // Reset game variables
                score = 0;
                timeLeft = DIFFICULTY[currentDifficulty].time;
                hits = 0;
                misses = 0;
                combo = 0;
                maxCombo = 0;
                comboTimer = 0;
                throws = 0;
                gameActive = false;
                gameStarted = false;
                gamePaused = false;
                isNightTime = false;
                
                // Clear arrays
                elves = [];
                trees = [];
                snowballsInAir = [];
                particles = [];
                snowflakes = [];
                powerups = [];
                
                // Reset powerups
                candyCaneActive = false;
                candyCaneTimer = 0;
                
                // Update UI
                updateUI();
                powerupBar.style.width = '0%';
                comboDisplay.style.display = 'none';
                powerupIndicator.style.display = 'none';
                gameOverElement.style.display = 'none';
                startScreen.style.display = 'flex'; // Show start screen
                
                // Create environment
                createTrees();
                createSnowflakes();
                
                // Start idle animation
                requestAnimationFrame(idleLoop);
            }
            
            // Start game
            function startGame() {
                gameActive = true;
                gameStarted = true;
                startScreen.style.display = 'none';
                
                timeLeft = DIFFICULTY[currentDifficulty].time;
                updateUI();
                
                spawnElf();
                lastTime = performance.now();
                gameLoop(lastTime);
                startTimer();
            }
            
            // Resize canvas
            function resizeCanvas() {
                canvas.width = canvas.parentElement.clientWidth;
                canvas.height = canvas.parentElement.clientHeight;
                groundY = canvas.height * 0.75;
            }
            
            // Create trees
            function createTrees() {
                trees = [];
                const treeCount = 8;
                const spacing = canvas.width / (treeCount + 1);
                
                for (let i = 0; i < treeCount; i++) {
                    trees.push({
                        x: spacing * (i + 1) + (Math.random() - 0.5) * 50,
                        y: groundY,
                        width: 70 + Math.random() * 50,
                        height: 110 + Math.random() * 70,
                        color: `hsl(${120 + Math.random() * 25}, 65%, ${25 + Math.random() * 20}%)`,
                        layer: Math.floor(Math.random() * 3)
                    });
                }
                
                trees.sort((a, b) => a.layer - b.layer);
            }
            
            // Create snowflakes
            function createSnowflakes() {
                snowflakes = [];
                for (let i = 0; i < 50; i++) {
                    snowflakes.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * canvas.height,
                        size: Math.random() * 3 + 1,
                        speed: Math.random() * 1.5 + 0.5,
                        drift: Math.random() * 0.8 - 0.4,
                        opacity: Math.random() * 0.5 + 0.5
                    });
                }
            }
            
            // Spawn elf
            function spawnElf() {
                if (!gameActive || elves.length >= 4) return;
                
                const tree = trees[Math.floor(Math.random() * trees.length)];
                const side = Math.random() > 0.5 ? 1 : -1;
                const health = DIFFICULTY[currentDifficulty].elfHealth;
                
                elves.push({
                    x: tree.x + side * (tree.width * 0.6),
                    y: tree.y - 40,
                    width: 50,
                    height: 60,
                    side: side,
                    tree: tree,
                    health: health,
                    maxHealth: health,
                    phase: 'peeking',
                    phaseTimer: 0,
                    peekDuration: 40,
                    timeVisible: 0,
                    throwCooldown: 0,
                    throwInterval: (isNightTime ? 1200 : 1800) / DIFFICULTY[currentDifficulty].elfSpeed,
                    isHit: false,
                    hitTimer: 0,
                    velocityX: 0,
                    velocityY: 0
                });
            }
            
            // Update UI
            function updateUI() {
                scoreElement.textContent = score;
                timerElement.textContent = timeLeft;
                hitsElement.textContent = hits;
                comboElement.textContent = combo;
                
                // Update powerup bar
                if (candyCaneActive) {
                    const percent = (candyCaneTimer / candyCaneDuration) * 100;
                    powerupBar.style.width = `${percent}%`;
                } else {
                    powerupBar.style.width = '0%';
                }
            }
            
            // Start timer
            function startTimer() {
                const timerInterval = setInterval(() => {
                    if (gameActive && !gamePaused) {
                        timeLeft--;
                        updateUI();
                        
                        // Check for nighttime
                        const elapsedTime = DIFFICULTY[currentDifficulty].time - timeLeft;
                        if (!isNightTime && elapsedTime >= 30) {
                            isNightTime = true;
                            showMessage("üåô NIGHTTIME! Elves are faster! üåô", '#4facfe');
                        }
                        
                        if (timeLeft <= 0) {
                            clearInterval(timerInterval);
                            endGame();
                        }
                    } else if (!gameActive) {
                        clearInterval(timerInterval);
                    }
                }, 1000);
            }
            
            // Show message
            function showMessage(text, color = '#ffd700') {
                comboDisplay.textContent = text;
                comboDisplay.style.color = color;
                comboDisplay.style.display = 'block';
                
                setTimeout(() => {
                    if (gameActive) {
                        comboDisplay.style.display = 'none';
                    }
                }, 2500);
            }
            
            // Idle loop for start screen
            function idleLoop(timestamp) {
                if (gameStarted) return;
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                drawBackground();
                drawSnowflakes();
                drawGround();
                drawTrees();
                
                // Animate some elves on start screen
                if (Math.random() < 0.02 && elves.length < 2) {
                    const tree = trees[Math.floor(Math.random() * trees.length)];
                    elves.push({
                        x: tree.x + (Math.random() > 0.5 ? 1 : -1) * (tree.width * 0.6),
                        y: tree.y - 40,
                        width: 50,
                        height: 60,
                        side: 1,
                        tree: tree,
                        phase: 'peeking',
                        phaseTimer: 0,
                        peekDuration: 100,
                        isHit: false,
                        hitTimer: 0
                    });
                }
                
                updateElves(16);
                
                requestAnimationFrame(idleLoop);
            }
            
            // Main game loop
            function gameLoop(currentTime) {
                if (!gameActive || gamePaused) return;
                
                const deltaTime = Math.min(currentTime - lastTime, 100);
                lastTime = currentTime;
                
                // Clear canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Update game state
                updateGameState(deltaTime);
                
                // Draw everything
                drawBackground();
                drawSnowflakes();
                drawGround();
                drawTrees();
                drawElves();
                drawPowerups();
                drawSnowballs();
                
                requestAnimationFrame(gameLoop);
            }
            
            // Update game state
            function updateGameState(deltaTime) {
                // Update timers
                if (comboTimer > 0) {
                    comboTimer -= deltaTime;
                    if (comboTimer <= 0) {
                        combo = 0;
                        updateUI();
                    }
                }
                
                if (candyCaneActive) {
                    candyCaneTimer -= deltaTime;
                    if (candyCaneTimer <= 0) {
                        candyCaneActive = false;
                        powerupIndicator.style.display = 'none';
                    }
                    updateUI();
                }
                
                // Spawn elves
                const spawnChance = DIFFICULTY[currentDifficulty].spawnRate * (isNightTime ? 1.5 : 1);
                if (Math.random() < spawnChance && elves.length < 4) {
                    spawnElf();
                }
                
                // Update game objects
                updateElves(deltaTime);
                updatePowerups(deltaTime);
                updateSnowballs(deltaTime);
                updateSnowflakes(deltaTime);
            }
            
            // Draw background
            function drawBackground() {
                // Sky gradient
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                
                if (isNightTime) {
                    gradient.addColorStop(0, '#0a1128');
                    gradient.addColorStop(0.5, '#1a2b52');
                    gradient.addColorStop(1, '#2d3561');
                } else {
                    gradient.addColorStop(0, '#87ceeb');
                    gradient.addColorStop(0.5, '#b8e0f6');
                    gradient.addColorStop(1, '#ffffff');
                }
                
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Sun or moon
                if (isNightTime) {
                    // Moon
                    ctx.beginPath();
                    ctx.arc(canvas.width - 80, 60, 35, 0, Math.PI * 2);
                    ctx.fillStyle = '#f4f4f4';
                    ctx.fill();
                    
                    // Stars
                    for (let i = 0; i < 30; i++) {
                        const x = (i * 73) % canvas.width;
                        const y = (i * 41) % (canvas.height * 0.5);
                        ctx.beginPath();
                        ctx.arc(x, y, Math.random() * 2 + 1, 0, Math.PI * 2);
                        ctx.fillStyle = `rgba(255, 255, 255, ${Math.random() * 0.5 + 0.5})`;
                        ctx.fill();
                    }
                } else {
                    // Sun
                    ctx.beginPath();
                    ctx.arc(canvas.width - 80, 60, 40, 0, Math.PI * 2);
                    ctx.fillStyle = '#ffd700';
                    ctx.fill();
                }
            }
            
            // Update and draw snowflakes
            function updateSnowflakes(deltaTime) {
                for (const flake of snowflakes) {
                    flake.y += flake.speed * (deltaTime / 16);
                    flake.x += flake.drift * (deltaTime / 16);
                    
                    if (flake.y > canvas.height) {
                        flake.y = -10;
                        flake.x = Math.random() * canvas.width;
                    }
                    
                    if (flake.x > canvas.width) flake.x = 0;
                    if (flake.x < 0) flake.x = canvas.width;
                }
            }
            
            function drawSnowflakes() {
                for (const flake of snowflakes) {
                    ctx.beginPath();
                    ctx.arc(flake.x, flake.y, flake.size, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(255, 255, 255, ${flake.opacity})`;
                    ctx.fill();
                }
            }
            
            // Draw ground
            function drawGround() {
                // Snow ground
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, groundY, canvas.width, canvas.height - groundY);
                
                // Snow texture
                ctx.fillStyle = 'rgba(230, 240, 255, 0.5)';
                for (let i = 0; i < 30; i++) {
                    const x = Math.random() * canvas.width;
                    const y = groundY + Math.random() * 50;
                    ctx.beginPath();
                    ctx.arc(x, y, Math.random() * 4 + 2, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            
            // Draw trees
            function drawTrees() {
                for (const tree of trees) {
                    // Tree trunk
                    ctx.fillStyle = isNightTime ? '#3d2817' : '#5d4037';
                    ctx.fillRect(tree.x - 12, tree.y - tree.height * 0.25, 24, tree.height * 0.25);
                    
                    // Tree layers
                    const layers = 4;
                    for (let i = 0; i < layers; i++) {
                        const layerY = tree.y - tree.height + (i * tree.height / layers);
                        const layerWidth = tree.width * (0.9 - i * 0.15);
                        const layerHeight = tree.height / layers;
                        
                        // Tree layer
                        ctx.fillStyle = tree.color;
                        ctx.beginPath();
                        ctx.moveTo(tree.x, layerY);
                        ctx.lineTo(tree.x - layerWidth/2, layerY + layerHeight);
                        ctx.lineTo(tree.x + layerWidth/2, layerY + layerHeight);
                        ctx.closePath();
                        ctx.fill();
                        
                        // Snow on tree
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                        ctx.beginPath();
                        ctx.moveTo(tree.x, layerY);
                        ctx.lineTo(tree.x - layerWidth/3, layerY + layerHeight * 0.7);
                        ctx.lineTo(tree.x + layerWidth/3, layerY + layerHeight * 0.7);
                        ctx.closePath();
                        ctx.fill();
                    }
                }
            }
            
            // Update elves
            function updateElves(deltaTime) {
                for (let i = elves.length - 1; i >= 0; i--) {
                    const elf = elves[i];
                    
                    if (elf.isHit) {
                        elf.hitTimer += deltaTime;
                        elf.x += elf.velocityX * (deltaTime / 16);
                        elf.y += elf.velocityY * (deltaTime / 16);
                        elf.velocityY += 0.5;
                        
                        if (elf.hitTimer > 100) {
                            elves.splice(i, 1);
                            if (gameActive) spawnElf();
                        }
                        continue;
                    }
                    
                    elf.phaseTimer += deltaTime;
                    
                    // State machine
                    switch (elf.phase) {
                        case 'peeking':
                            if (elf.phaseTimer >= elf.peekDuration) {
                                elf.phase = 'visible';
                                elf.phaseTimer = 0;
                                elf.timeVisible = 0;
                            }
                            break;
                            
                        case 'visible':
                            elf.timeVisible += deltaTime;
                            if (elf.timeVisible >= 3000) {
                                elf.phase = 'throwing';
                                elf.throwCooldown = 0;
                            }
                            break;
                            
                        case 'throwing':
                            elf.throwCooldown += deltaTime;
                            if (elf.throwCooldown >= elf.throwInterval) {
                                throwElfSnowball(elf);
                                elf.throwCooldown = 0;
                            }
                            break;
                    }
                }
            }
            
            // Draw elves
            function drawElves() {
                for (const elf of elves) {
                    if (elf.isHit) {
                        continue;
                    }
                    
                    let offset = 0;
                    if (elf.phase === 'peeking') {
                        const progress = elf.phaseTimer / elf.peekDuration;
                        offset = (1 - Math.min(progress * 2, 1)) * elf.width * 0.8;
                    }
                    
                    const drawX = elf.x + (elf.side > 0 ? offset : -offset);
                    const drawY = elf.y;
                    
                    // Elf body
                    ctx.fillStyle = '#2ecc71';
                    ctx.beginPath();
                    ctx.ellipse(drawX, drawY, elf.width * 0.35, elf.height * 0.4, 0, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Elf head
                    ctx.fillStyle = '#ffd1a3';
                    ctx.beginPath();
                    ctx.arc(drawX, drawY - elf.height * 0.35, elf.width * 0.25, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Elf hat
                    ctx.fillStyle = '#e74c3c';
                    ctx.beginPath();
                    ctx.moveTo(drawX, drawY - elf.height * 0.6);
                    ctx.lineTo(drawX - elf.width * 0.25, drawY - elf.height * 0.35);
                    ctx.lineTo(drawX + elf.width * 0.25, drawY - elf.height * 0.35);
                    ctx.closePath();
                    ctx.fill();
                    
                    // Hat pom-pom
                    ctx.fillStyle = '#ffffff';
                    ctx.beginPath();
                    ctx.arc(drawX, drawY - elf.height * 0.6, 8, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Eyes
                    ctx.fillStyle = '#333';
                    if (elf.phase === 'throwing') {
                        // Angry eyes
                        ctx.beginPath();
                        ctx.moveTo(drawX - 12, drawY - elf.height * 0.38);
                        ctx.lineTo(drawX - 4, drawY - elf.height * 0.35);
                        ctx.lineTo(drawX - 12, drawY - elf.height * 0.32);
                        ctx.fill();
                        
                        ctx.beginPath();
                        ctx.moveTo(drawX + 12, drawY - elf.height * 0.38);
                        ctx.lineTo(drawX + 4, drawY - elf.height * 0.35);
                        ctx.lineTo(drawX + 12, drawY - elf.height * 0.32);
                        ctx.fill();
                    } else {
                        // Normal eyes
                        ctx.beginPath();
                        ctx.arc(drawX - 8, drawY - elf.height * 0.35, 3, 0, Math.PI * 2);
                        ctx.arc(drawX + 8, drawY - elf.height * 0.35, 3, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }
            }
            
            // Throw elf snowball
            function throwElfSnowball(elf) {
                const targetX = canvas.width / 2;
                const targetY = canvas.height - 20;
                
                const dx = targetX - elf.x;
                const dy = targetY - elf.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                const speed = 10;
                
                snowballsInAir.push({
                    x: elf.x,
                    y: elf.y,
                    velocityX: (dx / distance) * speed,
                    velocityY: (dy / distance) * speed,
                    radius: 10,
                    life: 100,
                    isElfSnowball: true,
                    damage: 50
                });
            }
            
            // Throw player snowball
            function throwSnowball(x, y) {
                if (!gameActive || gamePaused) return;
                
                const rect = canvas.getBoundingClientRect();
                const targetX = x - rect.left;
                const targetY = y - rect.top;
                
                const startX = canvas.width / 2;
                const startY = canvas.height - 20;
                
                const dx = targetX - startX;
                const dy = targetY - startY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                const speed = candyCaneActive ? 18 : 14;
                
                throws++;
                
                if (candyCaneActive) {
                    // Triple shot
                    for (let i = -1; i <= 1; i++) {
                        const spreadAngle = Math.atan2(dy, dx) + (i * 0.2);
                        snowballsInAir.push({
                            x: startX,
                            y: startY,
                            velocityX: Math.cos(spreadAngle) * speed,
                            velocityY: Math.sin(spreadAngle) * speed,
                            radius: 12,
                            life: 80,
                            isCandyCane: true,
                            damage: 100
                        });
                    }
                } else {
                    // Single shot
                    snowballsInAir.push({
                        x: startX,
                        y: startY,
                        velocityX: (dx / distance) * speed,
                        velocityY: (dy / distance) * speed,
                        radius: 10,
                        life: 80,
                        damage: 50
                    });
                }
            }
            
            // Spawn powerup
            function spawnPowerup(x, y) {
                powerups.push({
                    x: x,
                    y: y,
                    width: 40,
                    height: 40,
                    velocityY: -8,
                    gravity: 0.3,
                    bounces: 0,
                    rotation: 0,
                    rotationSpeed: 0.05,
                    type: Math.random() > 0.7 ? 'time' : 'candy'
                });
            }
            
            // Update powerups
            function updatePowerups(deltaTime) {
                for (let i = powerups.length - 1; i >= 0; i--) {
                    const powerup = powerups[i];
                    
                    powerup.velocityY += powerup.gravity;
                    powerup.y += powerup.velocityY * (deltaTime / 16);
                    powerup.rotation += powerup.rotationSpeed;
                    
                    // Bounce on ground
                    if (powerup.y >= groundY - powerup.height/2) {
                        powerup.y = groundY - powerup.height/2;
                        powerup.velocityY *= -0.7;
                        powerup.bounces++;
                        
                        if (powerup.bounces > 2) {
                            powerup.velocityY = 0;
                        }
                    }
                }
            }
            
            // Draw powerups
            function drawPowerups() {
                for (const powerup of powerups) {
                    ctx.save();
                    ctx.translate(powerup.x, powerup.y);
                    ctx.rotate(powerup.rotation);
                    
                    // Present box
                    ctx.fillStyle = powerup.type === 'time' ? '#4facfe' : '#ff0000';
                    ctx.fillRect(-powerup.width/2, -powerup.height/2, powerup.width, powerup.height);
                    
                    // Ribbon
                    ctx.fillStyle = '#ffd700';
                    ctx.fillRect(-powerup.width/2, -3, powerup.width, 6);
                    ctx.fillRect(-3, -powerup.height/2, 6, powerup.height);
                    
                    ctx.restore();
                }
            }
            
            // Collect powerup
            function collectPowerup(x, y) {
                for (let i = powerups.length - 1; i >= 0; i--) {
                    const powerup = powerups[i];
                    const dx = x - powerup.x;
                    const dy = y - powerup.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < powerup.width) {
                        if (powerup.type === 'time') {
                            // Add time
                            timeLeft += 10;
                            showMessage("+10 SECONDS! ‚è±Ô∏è", '#4facfe');
                            updateUI();
                        } else {
                            // Activate candy cane
                            candyCaneActive = true;
                            candyCaneTimer = candyCaneDuration;
                            powerupIndicator.style.display = 'block';
                            showMessage("üç¨ CANDY CANE POWER ACTIVATED! üç¨", '#ff0000');
                        }
                        
                        powerups.splice(i, 1);
                        return true;
                    }
                }
                return false;
            }
            
            // Update snowballs
            function updateSnowballs(deltaTime) {
                for (let i = snowballsInAir.length - 1; i >= 0; i--) {
                    const snowball = snowballsInAir[i];
                    
                    snowball.x += snowball.velocityX * (deltaTime / 16);
                    snowball.y += snowball.velocityY * (deltaTime / 16);
                    snowball.life--;
                    
                    let hit = false;
                    
                    // Player snowball collision
                    if (!snowball.isElfSnowball) {
                        // Check elf hits
                        for (let j = elves.length - 1; j >= 0; j--) {
                            const elf = elves[j];
                            if (elf.isHit) continue;
                            
                            const dx = snowball.x - elf.x;
                            const dy = snowball.y - elf.y;
                            const distance = Math.sqrt(dx * dx + dy * dy);
                            
                            if (distance < snowball.radius + elf.width * 0.35) {
                                hit = true;
                                
                                elf.health--;
                                if (elf.health <= 0) {
                                    elf.isHit = true;
                                    elf.velocityX = (Math.random() - 0.5) * 10;
                                    elf.velocityY = -15;
                                    
                                    // Update score and combo
                                    combo++;
                                    if (combo > maxCombo) maxCombo = combo;
                                    comboTimer = 2000;
                                    
                                    const points = 100 * combo;
                                    score += points;
                                    hits++;
                                    
                                    // Show combo
                                    if (combo > 1) {
                                        showMessage(`COMBO x${combo}! +${points}`, '#ffd700');
                                    }
                                    
                                    // Spawn powerup every 3rd combo
                                    if (combo % 3 === 0) {
                                        spawnPowerup(elf.x, elf.y);
                                    }
                                    
                                    updateUI();
                                }
                                break;
                            }
                        }
                    } else {
                        // Elf snowball collision with player
                        if (snowball.y >= canvas.height - 50) {
                            hit = true;
                            score = Math.max(0, score - snowball.damage);
                            combo = 0;
                            updateUI();
                            showMessage(`-${snowball.damage} POINTS!`, '#ff6b6b');
                        }
                    }
                    
                    // Remove if hit or expired
                    if (hit || snowball.life <= 0) {
                        snowballsInAir.splice(i, 1);
                    }
                }
            }
            
            // Draw snowballs
            function drawSnowballs() {
                for (const snowball of snowballsInAir) {
                    if (snowball.isCandyCane) {
                        // Candy cane projectile
                        ctx.save();
                        
                        // Rotating stripes
                        const time = Date.now() * 0.01;
                        const stripes = 6;
                        for (let i = 0; i < stripes; i++) {
                            ctx.beginPath();
                            ctx.arc(
                                snowball.x, snowball.y, snowball.radius,
                                (i/stripes) * Math.PI * 2 + time,
                                ((i+0.5)/stripes) * Math.PI * 2 + time
                            );
                            ctx.lineTo(snowball.x, snowball.y);
                            ctx.closePath();
                            ctx.fillStyle = i % 2 === 0 ? '#ff0000' : '#ffffff';
                            ctx.fill();
                        }
                        
                        ctx.restore();
                    } else {
                        // Regular snowball
                        const gradient = ctx.createRadialGradient(
                            snowball.x, snowball.y, 1,
                            snowball.x, snowball.y, snowball.radius
                        );
                        
                        if (snowball.isElfSnowball) {
                            gradient.addColorStop(0, '#ffcccc');
                            gradient.addColorStop(1, '#ff6666');
                        } else {
                            gradient.addColorStop(0, '#ffffff');
                            gradient.addColorStop(1, '#80d4ff');
                        }
                        
                        ctx.beginPath();
                        ctx.arc(snowball.x, snowball.y, snowball.radius, 0, Math.PI * 2);
                        ctx.fillStyle = gradient;
                        ctx.fill();
                    }
                }
            }
            
            // End game
            function endGame() {
                gameActive = false;
                
                const accuracy = throws > 0 ? Math.round((hits / throws) * 100) : 0;
                
                finalScoreElement.textContent = score;
                finalHitsElement.textContent = hits;
                finalComboElement.textContent = maxCombo;
                finalAccuracyElement.textContent = `${accuracy}%`;
                finalTimeElement.textContent = `${DIFFICULTY[currentDifficulty].time - timeLeft}s`;
                
                // Determine rank
                let rank = '';
                if (score >= 3000) rank = 'üèÜ LEGENDARY ELF HUNTER! üèÜ';
                else if (score >= 2000) rank = '‚≠ê MASTER SNOWBALLER ‚≠ê';
                else if (score >= 1000) rank = 'üéØ EXPERT THROWER';
                else if (score >= 500) rank = '‚ùÑÔ∏è SKILLED MARKSMAN';
                else if (score >= 200) rank = 'üéÑ GOOD EFFORT!';
                else rank = '‚õÑ KEEP PRACTICING!';
                
                rankDisplay.textContent = rank;
                gameOverElement.style.display = 'flex';
            }
            
            // Pause game
            function togglePause() {
                if (!gameStarted || !gameActive) return;
                
                gamePaused = !gamePaused;
                const pauseBtn = document.getElementById('pause-btn');
                const icon = pauseBtn.querySelector('i');
                
                if (gamePaused) {
                    icon.className = 'fas fa-play';
                    pauseBtn.innerHTML = '<i class="fas fa-play"></i> Resume';
                    showMessage("GAME PAUSED", '#4facfe');
                } else {
                    icon.className = 'fas fa-pause';
                    pauseBtn.innerHTML = '<i class="fas fa-pause"></i> Pause';
                    lastTime = performance.now();
                    gameLoop(lastTime);
                }
            }
            
            // Toggle sound
            function toggleSound() {
                soundEnabled = !soundEnabled;
                const soundBtn = document.getElementById('sound-btn');
                const icon = soundBtn.querySelector('i');
                
                if (soundEnabled) {
                    icon.className = 'fas fa-volume-up';
                    soundBtn.innerHTML = '<i class="fas fa-volume-up"></i> Sound: ON';
                } else {
                    icon.className = 'fas fa-volume-mute';
                    soundBtn.innerHTML = '<i class="fas fa-volume-mute"></i> Sound: OFF';
                }
            }
            
            // Event listeners
            document.getElementById('start-btn').addEventListener('click', startGame);
            document.getElementById('play-again-btn').addEventListener('click', initGame);
            document.getElementById('reset-btn').addEventListener('click', initGame);
            document.getElementById('pause-btn').addEventListener('click', togglePause);
            document.getElementById('sound-btn').addEventListener('click', toggleSound);
            
            // Game canvas click event
            canvas.addEventListener('click', (e) => {
                if (!gameActive || gamePaused) return;
                
                const rect = canvas.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const clickY = e.clientY - rect.top;
                
                if (!collectPowerup(clickX, clickY)) {
                    throwSnowball(e.clientX, e.clientY);
                }
            });
            
            // Crosshair movement
            document.addEventListener('mousemove', (e) => {
                crosshair.style.left = e.clientX + 'px';
                crosshair.style.top = e.clientY + 'px';
                crosshair.style.display = 'block';
            });
            
            document.addEventListener('mouseleave', () => {
                crosshair.style.display = 'none';
            });
            
            // Difficulty selection
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentDifficulty = this.dataset.difficulty;
                });
            });
            
            // Handle window resize
            window.addEventListener('resize', () => {
                resizeCanvas();
                createTrees();
                createSnowflakes();
            });
            
            // Initialize the game
            initGame();
        });
    </script>
</body>
</html>
